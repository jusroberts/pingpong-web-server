// # Place all the behaviors and hooks related to the matching controller here.
// # All this logic will automatically be available in application.js.
// # You can use CoffeeScript in this file: http://coffeescript.org/
$(function() {
  var roomId = $('#room-id').text();
  window.dispatcher = new WebSocketRails(window.location.host + '/websocket');
  startListening();
  // update bars on page load
  scoreA($("#team_a_score").text());
  scoreB($("#team_b_score").text());

  function startListening() {
    channel = window.dispatcher.subscribe('room' + roomId);
    console.log(window.location.host + '/websocket');
    console.log('room' + roomId);

    dispatcher.bind('connection_closed', function() {
      console.log('Connection Lost!');
      reconnect = setInterval(function(){
        if (window.dispatcher.state === 'connected') {
          console.log('Reconnected.');
          startListening();
          console.log('Requesting latest scores...');
          $.get('/api/rooms/' + roomId + '/send_current_scores'), function ( data ) {
            console.log(data);
          }
          clearInterval(reconnect);
        } else {
          console.log('Attempting to reconnect...');
          window.dispatcher = new WebSocketRails(window.location.host + '/websocket');
        }
      }, 5000);
    });

    channel.bind('team_a_score', function(score) {
      scoreA(score);
      $("#team_a_score").text(score);
      console.log(score);
    });
    channel.bind('team_b_score', function(score) {
      scoreB(score);
      $("#team_b_score").text(score);
      console.log(score);
    });
    channel.bind('user_scan_new', function(player_id) {
      window.location.replace("/rooms/" + roomId + "/game/new/players/create?player_id=" + player_id);
      console.log("Redirecting to create player " + player_id);
    });
    channel.bind('user_scan_existing', function(playerData) {
      console.log(playerData.image_url);
      var imageSelector = ".player_" + playerData.team + "_" + playerData.player_number + "_img";
      $(imageSelector).attr("src", playerData.image_url);
      if (playerData.team == "a") {
        $('#scan_player1').attr('id','scan_player2');
      } else {
        $("#player2img").attr("src", playerData.image_url);
      }
    });
  }

});

$(function() {
  var background = "url(\"/images/match_backgrounds/bg_";
  background += Math.floor(Math.random() * 120) + 1;
  background += ".gif\")";
  background += " no-repeat center center fixed";
  $(".rooms.show").css({
    "background": background,
    "-webkit-background-size": "cover", /* For WebKit*/
    "-moz-background-size": "cover",    /* Mozilla*/
    "-o-background-size": "cover",      /* Opera*/
    "background-size": "cover"         /* Generic*/
  });
  $(".rooms.game_play").css({
    "background": background,
    "-webkit-background-size": "cover", /* For WebKit*/
    "-moz-background-size": "cover",    /* Mozilla*/
    "-o-background-size": "cover",      /* Opera*/
    "background-size": "cover"         /* Generic*/
  });
  $(".rooms.game_view").css({
    "background": background,
    "-webkit-background-size": "cover", /* For WebKit*/
    "-moz-background-size": "cover",    /* Mozilla*/
    "-o-background-size": "cover",      /* Opera*/
    "background-size": "cover"         /* Generic*/
  });
  $(".rooms.home").css({
    "background": background,
    "-webkit-background-size": "cover", /* For WebKit*/
    "-moz-background-size": "cover",    /* Mozilla*/
    "-o-background-size": "cover",      /* Opera*/
    "background-size": "cover"         /* Generic*/
  });
});

function scoreA(score) {
  if (score === 'W') {
    console.log("TEAM A SCORE = W")
    $("#team_a_status").css({"background" : 'url("/images/pong_assets/winner-animation.gif")',
                              "background-size": "75%",
                              "background-position": "center",
                              "background-repeat": "no-repeat"});
    $("#b_meter").animate({ width:"0%"});
    startContinueCountdown();
  } else if (score === 'G') {
    console.log("TEAM A SCORE = G")
    $("#b_meter").animate({ width:(100/21) + "%"});

  } else if (score === 'D') {
    console.log("TEAM A SCORE = D")
    $("#b_meter").animate({ width:"100%"});
    $("#b_meter").css({"background" : "#ED1C24"});

  } else if (score === 'ADV') {
    console.log("TEAM A SCORE = ADV")
    $("#a_meter").animate({ width:"100%"});
    $("#b_meter").animate({ width:"50%"});
    $("#a_meter").css({"background" : "#ED1C24"});
    $("#b_meter").css({"background" : "#ED1C24"});

  } else {
    $("#team_a_status").text('\xa0');
    $("#b_meter").animate({ width:((21- score)*100 /21)+ "%"});
  }

};

function scoreB(score) {
  if (score === 'W') {
    $("#team_b_status").css({"background" : 'url("/images/pong_assets/winner-animation.gif")',
                              "background-size": "75%",
                              "background-position": "center",
                              "background-repeat": "no-repeat"});
    $("#a_meter").animate({ width:"0%"});
    startContinueCountdown();
  } else if (score === 'G') {
    $("#a_meter").animate({ width:(100/21) + "%"});

  } else if (score === 'D') {
    $("#a_meter").animate({ width:"100%"});
    $("#a_meter").css({"background" : "#ED1C24"});

  } else if (score === 'ADV') {
    $("#b_meter").animate({ width:"100%"});
    $("#a_meter").animate({ width:"50%"});
    $("#a_meter").css({"background" : "#ED1C24"});
    $("#b_meter").css({"background" : "#ED1C24"});

  } else {
    $("#team_b_status").text('\xa0');
    $("#a_meter").animate({ width:((21- score)*100 /21)+ "%"});
  }

};

function startContinueCountdown() {
  $("#continueButton").css({"display": "block"});
  $("#continueButton").focus();
  var counter = 10;
  var id;
  id = setInterval(function() {
      counter--;
      if(counter <= 0) {
        var backgroundUrl = "url('/images/pong_assets/pong_continue 01.png')"
        $("#continueButton").css("background-image", backgroundUrl);
        clearInterval(id);
        $(".sf-quit").trigger('click');
      } else {
        var backgroundUrl = "url('/images/pong_assets/pong_continue 0" + counter + ".png')"
        $("#continueButton").css("background-image", backgroundUrl);
      }
  }, 1000);
}
